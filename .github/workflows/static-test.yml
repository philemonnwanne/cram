name: Run Static Code Analysis
on:
  push:
    branches:
      - main
env:
  NODE_VERSION: "16.x" # set this to the node version to use

jobs:
  testSourceCode:
    name: Test React Code âš›ï¸
    defaults:
      run:
        working-directory: "./frontend"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node and Cache
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install only the Lint Package
        run: npm ci

      - name: Testing Package Installation
        run: ls node_modules

      - name: Static Type Checker
        run: npm run flow
        continue-on-error: true

  testTerraformCode:
    name: ğŸ¢ Test Terraform Code ğŸ§
    defaults:
      run:
        working-directory: "./terraform"
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    env:
      TF_IN_AUTOMATION: true
      TF_INPUT: 0
    steps:
      - name: Checkout Repo ğŸ›’
        uses: actions/checkout@v3

      - name: Setup Terraform ğŸš¦
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: true

      - name: Terraform Format â„¹
        id: fmt
        run: terraform fmt -check

      - name: Terraform Validate  âœ…
        id: validate
        run: terraform validate

      - name: Terraform Status ğŸ¢
        if: steps.validate.outcome == 'failure' || steps.fmt.outcome == 'failure'
        run: exit 1
