name: ğŸ§± Generate Build Artifact
on:
  workflow_call:
env:
  NODE_VERSION: "16.x" # set this to the node version to use

jobs:
  build-frontend:
    name: ğŸ‘·ğŸ¾â€â™‚ï¸ Build Static Assets
    defaults:
      run:
        working-directory: "./frontend"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node and Cache
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install only the Lint Package
        run: npm ci

      - name: Build Artifact
        run: npm run build --if-present 

      - name: Zip Artifact for Deployment
        run: |
          cd dist
          zip release.zip ./* -r

      - name: ğŸ“¤ Upload Artifact for Deployment Job
        uses: actions/upload-artifact@v3
        with:
          name: react-app
          path: ${{ github.workspace }}/frontend/dist/release.zip

  # build-backend:
  #   name: ğŸŸ Deploy Image to ECS 
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: "./backend"
  #   steps:
  #     - name: Checkout Repo ğŸ›’
  #       uses: actions/checkout@v3

  #     - name: Configure AWS Credentials ğŸ¦¢
  #       uses: aws-actions/configure-aws-credentials@v3
  #       with:
  #         role-to-assume: ${{ secrets.ACTIONS_ROLE_ARN }}
  #         aws-region: ${{ vars.AWS_DEFAULT_REGION }}

  #     - name: Login to Amazon ECR
  #       id: login-ecr
  #       uses: aws-actions/amazon-ecr-login@v1
  #       with:
  #         mask-password: "true"

  #     - name: Build, Tag, and Push Docker Image to Amazon ECR
  #       env:
  #         ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
  #         IMAGE_TAG: ${{ github.sha }}
  #         ECR_REPOSITORY: azure
  #       run: |
  #         docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
  #         docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  plan-output:
    name: ğŸ‘¨ğŸ¾â€ğŸ’» Output Terraform Plan
    defaults:
      run:
        working-directory: "./terraform"
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    env:
      TF_IN_AUTOMATION: true
      TF_INPUT: 0
      TF_STATE: ${{ secrets.TF_STATE }} # S3 bucket for the Terraform state
    steps:
      - name: Checkout Repo ğŸ›’
        uses: actions/checkout@v3
      
      - name: Configure AWS Credentials ğŸ¦¢
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.ACTIONS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_DEFAULT_REGION }}

      - name: Setup Terraform ğŸš¦
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: true

      - name: ğŸ€ Terraform Init ğŸ
        id: init
        run: terraform init -backend-config="bucket=$TF_STATE"
        
      - name: Terraform Plan ğŸ‘¨ğŸ¾â€ğŸ’»
        id: plan
        # if: github.event_name == 'pull_request'
        run: terraform plan -out "tf_plan"
        continue-on-error: true

      - name: ğŸ“¤ Upload TF Plan
        uses: actions/upload-artifact@v3
        with:
          name: tf_plan
          path: ${{ github.workspace }}/terraform/tf_plan
          if-no-files-found: error
          retention-days: 1

  get-artifact:
    # environment: staging
    name: Download Build Files
    needs: [build-frontend, plan-output]
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Repo ğŸ›’
        uses: actions/checkout@v3

      - name: ğŸ“¥ Download Artifact from `Build` Workflow Run
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        # with:
        #   github_token: ${{secrets.GITHUB_TOKEN}}
        #   workflow: build.yml
        #   # branch: main
        #   workflow_conclusion: failure
        #   name: react-app
        #   # path: ${{ github.workspace }}/frontend/dist
        #   # if_no_artifact_found: fail
        continue-on-error: true

      - name: ğŸ“¥ Download artifact from build job
        uses: actions/download-artifact@v3
        with:
          name: react-app

      - name: DowLOAD MINE Artifa
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh run download -n react-app
          ls -R

      - name: Unzip Artifact for Deployment
        run: |
          ls -R
          unzip release.zip -d release

      - name: Move Artifact to Frontend Directory
        run: |
          mkdir ${GITHUB_WORKSPACE}/frontend/dist
          ls -R ${GITHUB_WORKSPACE}
          mv release/* ${GITHUB_WORKSPACE}/frontend/dist
